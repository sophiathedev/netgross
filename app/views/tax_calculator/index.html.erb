<% content_for :title, "Tính Thuế Thu Nhập Cá Nhân" %>

<div class="w-full max-w-4xl mx-auto" data-controller="tax-calculator" data-tax-calculator-calculating-value="false">
  <div id="flash_messages">
    <% if flash[:error] %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4">
        <%= flash[:error] %>
      </div>
    <% end %>
    
    <% if flash[:notice] %>
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mb-4">
        <%= flash[:notice] %>
      </div>
    <% end %>
  </div>

  <div class="bg-blue-600 text-white p-6 rounded-t-lg">
    <h1 class="text-2xl font-bold text-center">Tính Thuế Thu Nhập Cá Nhân</h1>
  </div>

  <div class="bg-white shadow-lg rounded-b-lg card-shadow">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6 responsive-grid">
      <div class="space-y-6">
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Thông tin đầu vào</h2>
        
        <%= form_with url: calculate_path, 
            method: :post, 
            local: false,
            class: "space-y-6", 
            data: { 
              tax_calculator_target: "form",
              action: "submit->tax-calculator#submitForm"
            } do |form| %>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Thu nhập chịu thuế (Thu nhập Gross) (VND)</label>
            <div class="relative">
              <%= form.text_field :gross_amount, 
                  value: @gross_amount, 
                  placeholder: "Nhập thu nhập hàng tháng", 
                  class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors",
                  inputmode: "numeric",
                  id: "gross_amount" %>
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Số người phụ thuộc</label>
            <%= form.number_field :dependent_count, 
                value: @dependent_count || 0, 
                min: 0, 
                class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors",
                id: "dependent_count" %>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Chế độ đóng bảo hiểm</label>
            <div class="space-y-3">
              <label class="flex items-center space-x-3">
                <%= form.radio_button :insurance_type, "based_on_gross", 
                    checked: (@insurance_type || :based_on_gross) == :based_on_gross,
                    class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300" %>
                <span class="text-sm text-gray-700">Đóng BHXH theo lương Gross (tối đa 46.8 triệu)</span>
              </label>
              <label class="flex items-center space-x-3">
                <%= form.radio_button :insurance_type, "fixed_amount", 
                    checked: @insurance_type == :fixed_amount,
                    class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300" %>
                <span class="text-sm text-gray-700">Đóng BHXH theo mức cố định</span>
              </label>
            </div>
          </div>

          <div class="space-y-2" id="insurance_rate_field" data-tax-calculator-target="insuranceRateField" style="<%= 'display: none;' unless @insurance_type == :fixed_amount %>">
            <label class="block text-sm font-medium text-gray-700">Số tiền đóng BHXH</label>
            <%= form.number_field :insurance_rate, 
                value: @insurance_rate, 
                placeholder: "Nhập mức đóng BHXH", 
                class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors",
                step: 1000 %>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Vùng</label>
            <%= form.select :tax_area, 
                options_for_select([
                  ["Vùng I", 1],
                  ["Vùng II", 2], 
                  ["Vùng III", 3],
                  ["Vùng IV", 4]
                ], @tax_area || 1),
                {},
                { class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors",
                  id: "tax_area" } %>
          </div>

          <div class="pt-4">
            <%= form.submit "Tính Thuế TNCN", 
                class: "w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",
                data: { tax_calculator_target: "submitButton" } %>
          </div>
        <% end %>
      </div>

      <div class="space-y-6">
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Kết quả tính toán</h2>
        
        <div id="calculation_result">
          <%= render "result" %>
        </div>
      </div>
    </div>

    <div class="border-t bg-gray-50 p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Bảng thuế suất thuế thu nhập cá nhân</h3>
      <div class="overflow-x-auto table-container">
        <table class="min-w-full bg-white border border-gray-200 rounded-xl tax-table">
          <thead class="bg-gray-100 rounded-t-xl">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Bậc thuế</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Thu nhập tính thuế/năm (triệu đồng)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Thu nhập tính thuế/tháng (triệu đồng)</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Thuế suất (%)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">1</td>
              <td class="px-4 py-3 text-sm text-gray-900">Đến 60 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Đến 5 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">5%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">2</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 60 đến 120 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 5 đến 10 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">10%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">3</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 120 đến 216 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 10 đến 18 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">15%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">4</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 216 đến 384 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 18 đến 32 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">20%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">5</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 384 đến 624 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 32 đến 52 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">25%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">6</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 624 đến 960 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 52 đến 80 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">30%</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm text-gray-900">7</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 960 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">Trên 80 tr</td>
              <td class="px-4 py-3 text-sm text-gray-900">35%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
